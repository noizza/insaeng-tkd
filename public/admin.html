<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
	/* Efecto ne√≥n amarillo desde los bordes para noticias importantes */
	.news-card {
		border-radius: 1rem;
		overflow: hidden;
		transform: scale(1);
		transition: transform 0.3s; 
	}
	.news-card.importante {
		position: relative;
	}
	.news-card.importante::before {
		content: "";
		position: absolute;
		top: 0; left: 0; right: 0; bottom: 0;
		border-radius: 1rem;
		pointer-events: none;
		opacity: 0;
		transition: opacity 0.3s;
		box-shadow: 0 0 20px 5px rgba(255, 255, 0, 0.8) inset;
	}
	.news-card.importante:hover::before {
		opacity: 1;
	}
	.news-card:hover {
		transform: scale(1.05);
		z-index: 10;
	}
</style>
</head>
<body class="bg-gray-200 dark:bg-gray-200 text-gray-900 dark:text-gray-900 p-6 flex">

<!-- MEN√ö IZQUIERDO -->
<aside class="w-64 bg-gray-300 dark:bg-gray-300 p-4 rounded-2xl flex-shrink-0">
	<h2 class="text-xl font-bold mb-6">Panel Admin</h2>
	<ul class="space-y-2">
		<li><button id="dashboardBtn" class="w-full text-left p-2 rounded hover:bg-cyan-700 dark:hover:bg-cyan-600 hover:text-white">Dashboard</button></li>
		<li><button id="createUserBtn" class="w-full text-left p-2 rounded hover:bg-cyan-700 dark:hover:bg-cyan-600 hover:text-white">Crear Usuario</button></li>
		<li><button id="adminNewsBtn" class="w-full text-left p-2 rounded hover:bg-cyan-700 dark:hover:bg-cyan-600 hover:text-white">Crear/Editar Noticias</button></li>
		<li><button id="btnAlbumes" class="w-full text-left p-2 rounded hover:bg-cyan-700 dark:hover:bg-cyan-600 hover:text-white">√Ålbumes</button></li>
		<li><button id="adminRolesBtn" class="w-full text-left p-2 rounded hover:bg-cyan-700 dark:hover:bg-cyan-600 hover:text-white hidden">Modificar Roles</button></li>
		<li><button id="btnAddSede" class="w-full text-left p-2 rounded hover:bg-cyan-700 dark:hover:bg-cyan-600 hover:text-white hidden">Sedes/Mapa</button></li>
	</ul>
</aside>

<!-- CONTENIDO -->
<main class="flex-1 ml-6">
	<header class="flex justify-end items-center mb-4">
		<button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-xl hover:bg-red-700 mr-2">Cerrar sesi√≥n</button>
		<button onclick="window.location.href='index.html'" class="bg-yellow-500 text-white px-4 py-2 rounded-xl hover:bg-yellow-600">Ir al inicio</button>
	</header>

	<!-- DASHBOARD -->
	<div id="dashboard" class="p-6 bg-white dark:bg-gray-300 rounded-2xl shadow-md">
		<h1 id="dashboardWelcome" class="text-2xl font-bold mb-4">Bienvenido</h1>
		<div id="hijosInfo" class="mb-4"></div>
		<div id="hijosList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
	</div>



	<!-- CREAR USUARIO -->
	<form id="adminCreateForm" class="hidden bg-white dark:bg-gray-300 p-6 rounded-2xl shadow-md max-w-md mb-6">
		<h2 class="text-xl font-semibold mb-4">Crear Usuario</h2>
		<label class="block mb-2">Nombre</label>
		<input type="text" name="nombre" required class="w-full p-2 border rounded mb-4 dark:bg-gray-200">
		<label class="block mb-2">Email</label>
		<input type="email" name="email" required class="w-full p-2 border rounded mb-4 dark:bg-gray-200">
		<label class="block mb-2">Contrase√±a</label>
		<input type="password" name="password" required class="w-full p-2 border rounded mb-4 dark:bg-gray-200">
		<label class="block mb-2">Rol</label>
		<select name="rol" class="w-full p-2 border rounded mb-4 dark:bg-gray-200">
			<option value="usuario">Usuario</option>
			<option value="moderador">Moderador</option>
			<option value="administrador">Administrador</option>
		</select>
		<button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-xl hover:bg-blue-700">Crear</button>
		<p id="adminCreateMsg" class="mt-3 text-sm text-center"></p>
	</form>

	<!-- ADMIN NEWS -->
	<div id="adminNews" class="hidden">
		<h2 class="text-xl font-semibold mb-4">Noticias</h2>
		<form id="createNewsForm" class="bg-white dark:bg-gray-300 p-6 rounded-2xl shadow-md mb-4">
			<label class="block mb-2">T√≠tulo</label>
			<input type="text" name="title" required class="w-full p-2 border rounded mb-2 dark:bg-gray-200">
			<label class="block mb-2">Texto</label>
			<textarea name="text" required class="w-full p-2 border rounded mb-2 dark:bg-gray-200"></textarea>
			<label class="block mb-2">Imagen URL (opcional)</label>
			<input type="text" name="imageUrl" class="w-full p-2 border rounded mb-2 dark:bg-gray-200" placeholder="Si no se ingresa o pones '#', se mostrar√° un color aleatorio">
			<label class="block mb-2">Tipo</label>
			<select name="tipo" class="w-full p-2 border rounded mb-2 dark:bg-gray-200">
				<option value="normal">Noticia normal</option>
				<option value="importante">Noticia importante</option>
			</select>
			<button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-xl hover:bg-green-700">Guardar</button>
		</form>
		<div id="newsList" class="grid gap-4 grid-cols-1 sm:grid-cols-2 md:grid-cols-3"></div>
		</div>
		<!-- ALBUMES -->
		<div id="adminAlbumes" class="hidden p-4">
			<h2 class="text-xl font-bold mb-4">Gesti√≥n de √Ålbumes</h2>

			<form id="albumForm" class="space-y-3 mb-4">
				<input type="hidden" id="albumId">
				<input type="text" id="albumNombre" placeholder="Nombre del √°lbum" class="w-full p-2 border rounded" required>
				<textarea id="albumDescripcion" placeholder="Descripci√≥n" class="w-full p-2 border rounded"></textarea>
				<textarea id="albumFotos" placeholder="[url=...][img]...[/img][/url], uno por l√≠nea" class="w-full p-2 border rounded"></textarea>
				<div class="flex gap-2">
				<button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Guardar</button>
				<button type="button" id="cancelAlbumBtn" class="bg-gray-400 px-4 py-2 rounded hover:bg-gray-500">Cancelar</button>
				</div>
			</form>

			<div id="albumesList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
		</div>

		<!-- ROLES -->
		<div id="adminRoles" class="hidden p-6 bg-white dark:bg-gray-300 rounded-2xl shadow-md">
			<h2 class="text-xl font-semibold mb-4">Roles</h2>

			<form id="createRoleForm" class="mb-4">
				<input type="text" name="nombre" placeholder="Nombre del rol" class="p-2 border rounded dark:bg-gray-200" required>
				<label class="block mb-2">Nivel</label>
				<input type="number" name="nivel" min="1" max="20" required class="w-full p-2 border rounded mb-4 dark:bg-gray-200">
				<button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700">Crear rol</button>
				<p id="roleMsg" class="mt-2 text-sm"></p>
			</form>

			<div id="roleList" class="space-y-2"></div>
		</div>
		<!-- MODAL EDITAR ROL -->
		<div id="editRoleModal" class="fixed inset-0 bg-grey-300 bg-opacity-50 hidden items-center justify-center z-50">
		<div class="bg-white rounded-2xl shadow-md w-1/3 p-6 relative">
			<button onclick="closeEditRoleModal()" 
					class="absolute top-4 right-4 text-gray-700 font-bold text-2xl hover:text-red-600">&times;</button>
			
			<h3 class="text-xl font-bold mb-4">Editar Rol</h3>
			<form id="editRoleForm" class="space-y-4">
			<input type="hidden" id="editRoleId" name="id">
			<div>
				<label class="block text-sm font-semibold">Nombre</label>
				<input type="text" id="editRoleName" name="nombre" class="border rounded w-full p-2">
			</div>
			
			<div>
				<label class="block text-sm font-semibold">Nivel</label>
				<input type="number" id="editRoleLevel" name="nivel" min="1" class="border rounded w-full p-2">
			</div>
			
			<button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
				Guardar cambios
			</button>
			</form>
			<p id="editRoleMsg" class="mt-2"></p>
		</div>
	</div>
	<!-- MODAL EDITAR ALUMNO -->
	<div id="editHijoModal" class="fixed inset-0 bg-gray-300 bg-opacity-50 hidden items-center justify-center z-50">
		<div class="bg-white rounded-2xl shadow-md w-1/3 p-6 relative">
			<button onclick="closeEditHijoModal()" 
					class="absolute top-4 right-4 text-gray-700 font-bold text-2xl hover:text-red-600">&times;</button>
			
			<h3 class="text-xl font-bold mb-4">Editar Alumno</h3>
			<form id="editHijoForm" class="space-y-4">
				<input type="hidden" id="editHijoId" name="id">
				
				<div>
					<label class="block text-sm font-semibold">Nombre</label>
					<input type="text" id="editHijoNombre" name="nombre" class="border rounded w-full p-2" required>
				</div>
				
				<div>
					<label class="block text-sm font-semibold">Email</label>
					<input type="email" id="editHijoEmail" name="email" class="border rounded w-full p-2" required>
				</div>
				
				<div>
					<label class="block text-sm font-semibold">Rol</label>
					<select id="editHijoRol" name="rol_id" class="border rounded w-full p-2"></select>
				</div>

				<div>
					<label class="block text-sm font-semibold">Foto de perfil (URL)</label>
					<input type="text" id="editHijoImageUrl" name="imageUrl" class="border rounded w-full p-2">
				</div>
				
				<button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
					Guardar cambios
				</button>
			</form>
			<p id="editHijoMsg" class="mt-2"></p>
		</div>
	</div>
  <!-- Modal de Notas -->
  <div id="notasModal" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-50 hidden z-50">
		<div class="bg-white p-6 rounded-2xl max-w-4xl w-full overflow-auto max-h-[80vh]">
			<h2 class="text-xl font-bold mb-4" id="notasModalTitulo">Libreta de <span id="notasModalNombre"></span></h2>

			<div class="flex items-center justify-between mb-2">
				<button id="prevCategoria" class="px-2 py-1 bg-gray-400 text-white rounded hover:bg-gray-600">‚¨ÖÔ∏è</button>
				<span id="categoriaLabel" class="font-semibold text-lg">Categor√≠a</span>
				<button id="nextCategoria" class="px-2 py-1 bg-gray-400 text-white rounded hover:bg-gray-600">‚û°Ô∏è</button>
			</div>

			<div id="libretaModalContainer" class="mt-6"></div>

			<div class="mt-4 flex justify-end space-x-2">
				<button id="guardarNotasBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Guardar</button>
				<button id="cerrarNotasBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Cerrar</button>
			</div>
		</div>
	</div>
	<!-- SEDES / MAPA -->
	<div id="adminSedes" class="hidden p-6 bg-white dark:bg-gray-300 rounded-2xl shadow-md">
		<h2 class="text-xl font-semibold mb-4">Sedes / Mapa</h2>

		<!-- Formulario para agregar o editar sedes -->
		<form id="sedeForm" class="bg-white dark:bg-gray-200 p-4 rounded-2xl shadow-md mb-4 max-w-md">
			<input type="hidden" name="id" id="sedeId">
			<label class="block mb-2">Nombre de la sede</label>
			<input type="text" name="nombre" id="sedeNombre" required class="w-full p-2 border rounded mb-2 dark:bg-gray-100">

			<label class="block mb-2">Descripci√≥n</label>
			<textarea name="descripcion" id="sedeDescripcion" rows="4" class="w-full p-2 border rounded mb-2 dark:bg-gray-100"></textarea>
			
			<label class="block mb-2">Coordenadas (lat, lng)</label>
			<input type="text" name="coords" id="sedeCoords" placeholder="-27.328580, -55.051506" required class="w-full p-2 border rounded mb-2 dark:bg-gray-100">

			<label class="block mb-2">Ciudad</label>
			<input type="text" name="ciudad" id="sedeCiudad" placeholder="Ej: Posadas" required  class="w-full p-2 border rounded mb-2 dark:bg-gray-100">
			
			<button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-xl hover:bg-green-700">Guardar</button>
			<button type="button" id="cancelSedeBtn" class="bg-gray-500 text-white px-4 py-2 rounded-xl hover:bg-gray-600 ml-2">Cancelar</button>
		</form>

		<!-- Lista de sedes existentes -->
		<div id="sedesList" class="grid gap-4 grid-cols-1 sm:grid-cols-2 md:grid-cols-3"></div>
	</div>

</main>

<script>
// ============================
// TOKEN Y ACCESO
// ============================
const token = localStorage.getItem("token");
if (!token) { alert("Debes iniciar sesi√≥n como administrador."); window.location.href = "/index.html"; }

function logout(){ localStorage.removeItem("token"); window.location.href="/index.html"; }

const payload = JSON.parse(atob(token.split('.')[1]));
if(payload.nivel == 20){
	document.getElementById("adminRolesBtn").classList.remove("hidden");
	document.getElementById("btnAddSede").classList.remove("hidden");
}

// ============================
// DOM - PAGINA CARGADA
// ============================
window.addEventListener("DOMContentLoaded", () => {
	// Mostrar dashboard
	dashboard.classList.remove("hidden");
	adminCreateForm.classList.add("hidden");
	adminAlbumes.classList.add("hidden");
	adminNews.classList.add("hidden");
	adminRoles.classList.add("hidden");
	adminSedes.classList.add("hidden");

	// Cargar datos din√°micos
	loadDashboard();
});

// ============================
// MENU IZQUIERDO
// ============================
const dashboard = document.getElementById("dashboard");
const adminCreateForm = document.getElementById("adminCreateForm");
const adminNews = document.getElementById("adminNews");
const adminRoles = document.getElementById("adminRoles");
const adminSedes = document.getElementById("adminSedes");
const adminAlbumes = document.getElementById("adminAlbumes");
document.getElementById("dashboardBtn").onclick = async () => { dashboard.classList.remove("hidden"); adminCreateForm.classList.add("hidden"); adminNews.classList.add("hidden"); adminRoles.classList.add("hidden"); adminSedes.classList.add("hidden"); adminAlbumes.classList.add("hidden");await loadDashboard(); };
document.getElementById("createUserBtn").onclick = async ()=>{ dashboard.classList.add("hidden"); adminCreateForm.classList.remove("hidden"); adminNews.classList.add("hidden"); adminRoles.classList.add("hidden"); adminSedes.classList.add("hidden"); adminAlbumes.classList.add("hidden"); await loadRolesOptions(); };
document.getElementById("adminNewsBtn").onclick = ()=>{ dashboard.classList.add("hidden"); adminCreateForm.classList.add("hidden"); adminNews.classList.remove("hidden"); adminRoles.classList.add("hidden"); adminSedes.classList.add("hidden"); adminAlbumes.classList.add("hidden"); loadNews(); };
document.getElementById("btnAlbumes").onclick = ()=>{ dashboard.classList.add("hidden"); adminCreateForm.classList.add("hidden"); adminNews.classList.add("hidden"); adminRoles.classList.add("hidden"); adminSedes.classList.add("hidden"); adminAlbumes.classList.remove("hidden"); loadAlbumes(); };
document.getElementById("adminRolesBtn").onclick = async ()=>{ dashboard.classList.add("hidden"); adminCreateForm.classList.add("hidden"); adminNews.classList.add("hidden"); adminSedes.classList.add("hidden"); adminAlbumes.classList.add("hidden"); adminRoles.classList.remove("hidden"); await loadRoles(); };
document.getElementById("btnAddSede").onclick = ()=>{ dashboard.classList.add("hidden"); adminCreateForm.classList.add("hidden"); adminNews.classList.add("hidden"); adminRoles.classList.add("hidden"); adminAlbumes.classList.add("hidden"); adminSedes.classList.remove("hidden"); loadSedes(); };

// ============================
// USUARIOS
// ============================
const adminCreateMsg = document.getElementById("adminCreateMsg");
adminCreateForm.addEventListener("submit", async e=>{
	e.preventDefault();
	const token = localStorage.getItem("token");
	const tokenData = JSON.parse(atob(token.split('.')[1])); // payload del JWT
	const creatorId = tokenData.id;
	const payload = {
		nombre: adminCreateForm.nombre.value,
		email: adminCreateForm.email.value,
		password: adminCreateForm.password.value,
		rol_id: parseInt(adminCreateForm.rol.value),
		creatorId: creatorId
	};
	const res = await fetch("/admin/register", { method:"POST", headers:{ "Content-Type":"application/json","Authorization":"Bearer "+token }, body:JSON.stringify(payload)});
	const text = await res.text();
	adminCreateMsg.textContent = text;
	adminCreateMsg.className = res.ok ? "text-green-600 text-center mt-3" : "text-red-600 text-center mt-3";
	if(res.ok) adminCreateForm.reset();
});

// ============================
// NOTICIAS
// ============================
const newsList = document.getElementById("newsList");
const createNewsForm = document.getElementById("createNewsForm");
let editId = null;

// Color aleatorio
function randomColor(){ return '#' + Math.floor(Math.random()*16777215).toString(16); }

// Cargar noticias
async function loadNews(){
	newsList.innerHTML = "";
	const res = await fetch("/news");
	const data = await res.json();

	data.forEach(n=>{
		const div = document.createElement("div");
		div.className = `news-card ${n.tipo == 1 ? 'importante':''} bg-white dark:bg-gray-300 p-4 rounded-2xl shadow-md`;

		const imageContent = (!n.imageUrl || n.imageUrl === "#")
			? `<div class="mb-2 w-full h-32 rounded" style="background-color:${randomColor()};"></div>`
			: `<img src="${n.imageUrl}" class="mb-2 w-full h-32 object-cover rounded">`;

		const textPreview = n.text.length > 100 ? n.text.substring(0,100) + "..." : n.text;

		div.innerHTML = `
			${imageContent}
			<h3 class="font-bold text-lg mb-1">${n.title}</h3>
			<p class="mb-2">${textPreview}</p>
			<div class="flex space-x-2">
				<button data-id="${n.id}" class="editBtn bg-blue-600 text-white px-2 py-1 rounded">Editar</button>
				<button data-id="${n.id}" class="delBtn bg-red-600 text-white px-2 py-1 rounded">Eliminar</button>
			</div>
		`;
		newsList.appendChild(div);
	});
}

// Crear/Editar noticia
createNewsForm.addEventListener("submit", async e=>{
	e.preventDefault();
	const imageUrlValue = createNewsForm.imageUrl.value.trim();
	const tipoNum = createNewsForm.tipo.value === "importante" ? 1 : 0;
	const payload = {
		title: createNewsForm.title.value,
		text: createNewsForm.text.value,
		tipo: tipoNum,
		imageUrl: tipoNum == 1 
				? "https://consejomedicolp.org.ar/wp-content/uploads/2024/02/avisoImportante3.jpg" 
				: (imageUrlValue === "" || imageUrlValue === "#") ? "#" : imageUrlValue,
	};
	let res;
	if(editId){
		res = await fetch("/admin/news/"+editId,{ method:"PUT", headers:{ "Content-Type":"application/json","Authorization":"Bearer "+token }, body:JSON.stringify(payload)});
	} else {
		res = await fetch("/admin/news",{ method:"POST", headers:{ "Content-Type":"application/json","Authorization":"Bearer "+token }, body:JSON.stringify(payload)});
	}
	if(res.ok){ createNewsForm.reset(); editId=null; loadNews(); }
});

// Edit/Delete
newsList.addEventListener("click", async e=>{
	if(e.target.classList.contains("editBtn")){
		const id = e.target.dataset.id;
		const res = await fetch("/news");
		const data = await res.json();
		const n = data.find(x=>x.id==id);
		createNewsForm.title.value = n.title;
		createNewsForm.text.value = n.text;
		createNewsForm.imageUrl.value = n.imageUrl;
		createNewsForm.tipo.value = n.tipo;
		editId = id;
	}
	if(e.target.classList.contains("delBtn")){
		if(!confirm("Eliminar noticia?")) return;
		await fetch("/admin/news/"+e.target.dataset.id,{ method:"DELETE", headers:{ "Authorization":"Bearer "+token }});
		loadNews();
	}
});

// ============================
// ROLES
// ============================
const roleMsg = document.getElementById("roleMsg");
const createRoleForm = document.getElementById("createRoleForm");
const roleList = document.getElementById("roleList");

createRoleForm.addEventListener("submit", async e=>{
	e.preventDefault();
	const payload = {
		nombre: createRoleForm.nombre.value,
		nivel: parseInt(createRoleForm.nivel.value)
	};
  	const res = await fetch("/admin/roles", {
  	  method: "POST",
  	  headers: {"Content-Type":"application/json", "Authorization":"Bearer "+token},
  	  body: JSON.stringify(payload)
  	});
  	const text = await res.text();
  	roleMsg.textContent = text;
  	roleMsg.className = res.ok ? "text-green-600 mt-2" : "text-red-600 mt-2";
  	if(res.ok) createRoleForm.reset();
  	loadRoles();
});

// Cargar/Editar roles existentes
async function loadRoles(){
  const res = await fetch("/admin/roles", { headers: {"Authorization":"Bearer "+token} });
  const roles = await res.json();
  roles.sort((a, b) => a.nivel - b.nivel);
  roleList.innerHTML = "";

  // Traer todos los usuarios para saber qu√© roles est√°n asignados
  const usersRes = await fetch("/admin/users", { headers: {"Authorization":"Bearer "+token} });
  const users = await usersRes.json();

  roles.forEach(r=>{
	const div = document.createElement("div");
	div.className = "flex justify-between items-center p-2 border rounded dark:bg-gray-200 space-x-2";

	div.innerHTML = `
	  <span>${r.nombre}</span>
	  <div class="flex space-x-2">
		<button class="editRoleBtn bg-yellow-500 text-white px-2 py-1 rounded">Editar</button>
	  </div>
	`;

	// Editar
	div.querySelector(".editRoleBtn").onclick = ()=> openEditRoleModal(r);

	// Eliminar solo si ning√∫n usuario tiene este rol
	const assigned = users.some(u => u.rol === r.nombre);
	if(!assigned){
	  const deleteBtn = document.createElement("button");
	  deleteBtn.className = "delRoleBtn bg-red-600 text-white px-2 py-1 rounded";
	  deleteBtn.textContent = "Eliminar";
	  deleteBtn.onclick = async () => {
		if(!confirm(`¬øEliminar el rol "${r.nombre}"?`)) return;
		const res = await fetch(`/admin/roles/${r.id}`, {
		  method: "DELETE",
		  headers: {"Authorization":"Bearer " + token}
		});
		if(res.ok){
		  loadRoles(); // recarga la lista
		} else {
		  const text = await res.text();
		  alert("Error al eliminar rol: " + text);
		}
	  };
	  div.querySelector("div.flex").appendChild(deleteBtn);
	}

	roleList.appendChild(div);
  });
}

function openEditRoleModal(role) {
  if (!role.id) {
	console.error("El rol no tiene ID", role);
	return;
  }
  document.getElementById("editRoleId").value = role.id;
  document.getElementById("editRoleName").value = role.nombre;
  document.getElementById("editRoleLevel").value = role.nivel;

  document.getElementById("editRoleModal").classList.remove("hidden");
  document.getElementById("editRoleModal").classList.add("flex");
}

function closeEditRoleModal() {
  document.getElementById("editRoleModal").classList.add("hidden");
  document.getElementById("editRoleModal").classList.remove("flex");
}

document.getElementById("editRoleForm").addEventListener("submit", async e => {
  e.preventDefault();

  const id = parseInt(document.getElementById("editRoleId").value);
  let nivel = parseInt(document.getElementById("editRoleLevel").value);
  if(isNaN(nivel) || nivel < 1) nivel = 1;

  const payload = {
	nombre: document.getElementById("editRoleName").value.trim(),
	nivel: nivel
  };

  const res = await fetch(`/admin/roles/${id}`, {
	method: "PATCH",
	headers: { 
	  "Content-Type": "application/json", 
	  "Authorization": "Bearer " + token 
	},
	body: JSON.stringify(payload)
  });

  const text = await res.text();
  const msg = document.getElementById("editRoleMsg");
  msg.textContent = text;
  msg.className = res.ok ? "text-green-600 mt-2" : "text-red-600 mt-2";

  if (res.ok) {
	loadRoles();
	setTimeout(() => closeEditRoleModal(), 1000);
  }
});

async function loadRolesOptions() {
	const res = await fetch("/admin/roles", { headers: { "Authorization": "Bearer " + token } });
	const roles = await res.json();

	// Nivel del usuario actual desde el token
	const payload = JSON.parse(atob(token.split('.')[1]));
	const userNivel = payload.nivel || 1;

	const select = document.querySelector("#adminCreateForm select[name='rol']");
	select.innerHTML = "";

	// Filtramos solo roles de nivel menor al usuario actual
	const rolesFiltrados = roles.filter(r => r.nivel < userNivel);

	// Ordenamos por nivel ascendente
	rolesFiltrados.sort((a, b) => a.nivel - b.nivel);

	rolesFiltrados.forEach(r => {
		const option = document.createElement("option");
		option.value = r.id; // usamos el ID ahora
		option.textContent = `${r.nombre} (nivel ${r.nivel})`;
		select.appendChild(option);
	});

	// Si no hay roles disponibles
	if (rolesFiltrados.length === 0) {
		const option = document.createElement("option");
		option.value = "";
		option.textContent = "No hay roles disponibles";
		select.appendChild(option);
	}
}

// ============================
// DASHBOARD
// ============================
function openEditHijoModal(hijo) {
	document.getElementById("editHijoId").value = hijo.id;
	document.getElementById("editHijoNombre").value = hijo.nombre;
	document.getElementById("editHijoEmail").value = hijo.email || "";
	document.getElementById("editHijoImageUrl").value = hijo.imageUrl || "https://i.postimg.cc/v8LP9H67/logo-white-removebg-preview.png";

	const select = document.getElementById("editHijoRol");
	select.innerHTML = "";

	// Cargar roles filtrados seg√∫n el nivel del usuario actual
	fetch("/admin/roles", { headers: { "Authorization": "Bearer " + token } })
		.then(res => res.json())
		.then(roles => {
			const payload = JSON.parse(atob(token.split('.')[1]));
			const userNivel = payload.nivel || 1;

			roles.filter(r => r.nivel < userNivel).forEach(r => {
				const option = document.createElement("option");
				option.value = r.id;
				option.textContent = `${r.nombre} (nivel ${r.nivel})`;
				if(r.id === hijo.rol_id) option.selected = true;
				select.appendChild(option);
			});
		});

	document.getElementById("editHijoModal").classList.remove("hidden");
	document.getElementById("editHijoModal").classList.add("flex");
}

function closeEditHijoModal() {
	document.getElementById("editHijoModal").classList.add("hidden");
	document.getElementById("editHijoModal").classList.remove("flex");
}

document.getElementById("editHijoForm").addEventListener("submit", async e => {
	e.preventDefault();
	const id = parseInt(document.getElementById("editHijoId").value);
	const nombre = document.getElementById("editHijoNombre").value.trim();
	const email = document.getElementById("editHijoEmail").value.trim();
	const rol_id = parseInt(document.getElementById("editHijoRol").value);
	const imageUrl = document.getElementById("editHijoImageUrl").value.trim();

	const res = await fetch(`/admin/users/${id}`, {
		method: "PATCH",
		headers: { 
			"Content-Type": "application/json",
			"Authorization": "Bearer " + token 
		},
		body: JSON.stringify({ nombre, email, rol_id, imageUrl })
	});

	const text = await res.text();
	const msg = document.getElementById("editHijoMsg");
	msg.textContent = text;
	msg.className = res.ok ? "text-green-600 mt-2" : "text-red-600 mt-2";

	if(res.ok){
		loadDashboard();           // recarga lista de hijos
		setTimeout(() => closeEditHijoModal(), 1000);
	}
});

async function loadDashboard() {
	// Obtener datos de usuario y sus hijos
	const res = await fetch("/admin/children", {
		headers: { "Authorization": "Bearer " + token }
	});
	const data = await res.json();
	const hijos = data.hijos || data; // CORRECCI√ìN

	// Mostrar mensaje de bienvenida con Sobrenombre de rol
	const payload = JSON.parse(atob(token.split('.')[1]));
	let sobrenombre;
	if(payload.nivel >= 11 && payload.nivel <= 13) sobrenombre = "Sabon";
	else if(payload.nivel >= 14 && payload.nivel <= 16) sobrenombre = "Sabon-Nim";
	else if(payload.nivel >= 17 && payload.nivel <= 18) sobrenombre = "Sagium-Nim";
	else if(payload.nivel == 17) sobrenombre = "Sasong-Nim";
	else sobrenombre = "";

	document.getElementById("dashboardWelcome").textContent =
		`Bienvenido ${sobrenombre} ${payload.nombre}`;


	// INFORMACI√ìN RESUMIDA DE HIJOS
	const rolEmojis = {
		1: "‚¨ú",
		2: "‚¨úüü®",
		3: "üü®",
		4: "üü®üü©",
		5: "üü©",
		6: "üü©üü¶",
		7: "üü¶",
		8: "üü¶üü•",
		9: "üü•",
		10: "üü•‚¨õ",
		11: "‚¨õ"
	};
	const hijosInfo = document.getElementById("hijosInfo");
	if(!hijos || hijos.length === 0) {
		hijosInfo.innerHTML = `<p class="text-red-600 font-semibold">No hay informaci√≥n de que tengas hijos a cargo</p>`;
	} else {
		// Contar hijos por rol
		const conteoRoles = {};
		hijos.forEach(h => {
			conteoRoles[h.rol_id] = (conteoRoles[h.rol_id] || 0) + 1;
		});

		let infoHTML = `<p class="font-semibold mb-2">Informaci√≥n de alumnos:</p>`;
		infoHTML += `<p>Total de alumnos: ${hijos.length}</p>`;
		for(const rolId in conteoRoles) {
			const hijoConRol = hijos.find(h => h.rol_id == rolId);
			const rolNombre = hijoConRol ? hijoConRol.rol : "Desconocido";
			const nivel = hijoConRol ? hijoConRol.rol_nivel : 0;  // <-- CORRECTO
			let emoji;
			if(nivel >= 10) {
				emoji = "‚¨õ";
			} else {
				emoji = rolEmojis[nivel] || "";
			}
			infoHTML += `<p>${emoji}${rolNombre}: ${conteoRoles[rolId]}</p>`;
		}
		hijosInfo.innerHTML = infoHTML;
	}
	//
	const hijosList = document.getElementById("hijosList");
	hijosList.innerHTML = "";

	hijos.forEach(h => {
		const div = document.createElement("div");
		div.className = "p-4 border rounded-xl shadow-md flex flex-col items-center text-center bg-white dark:bg-gray-200";

		const profileUrl = h.url_fotop && h.url_fotop !== "" 
			? h.url_fotop 
			: "https://i.postimg.cc/v8LP9H67/logo-white-removebg-preview.png";

		div.innerHTML = `
			<img src="${profileUrl}" class="w-20 h-20 rounded-full object-cover mb-3">
			<span class="font-semibold text-gray-800">${h.nombre}</span>
			<span class="text-sm text-gray-500 mb-3">(${h.rol})</span>

			<div class="flex flex-col w-full gap-2">
				<!-- Primera fila: Editar | Notas -->
				<div class="flex gap-2">
					<button class="editHijoBtn flex-1 px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Editar</button>
					<button class="notasHijoBtn flex-1 px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700">Notas</button>
				</div>
				<!-- Segunda fila: Eliminar -->
				<button class="delHijoBtn w-full px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Eliminar</button>
			</div>
		`;

		// Eventos botones
		div.querySelector(".editHijoBtn").onclick = () => openEditHijoModal(h);
		div.querySelector(".notasHijoBtn").onclick = () => openNotasModal(h);
		div.querySelector(".delHijoBtn").onclick = async () => {
			if(confirm(`Eliminar a ${h.nombre}?`)) {
				const res = await fetch(`/admin/users/${h.id}`, {
					method: "DELETE",
					headers: { "Authorization": "Bearer " + token }
				});
				if(res.ok) loadDashboard();
				else alert(await res.text());
			}
		};

		hijosList.appendChild(div);
	});


}

//============= MODAL DE NOTAS/HIJOS ======================
let notasHijo = [];
let categoriaIndex = 0;
let notasHijoId = null;

async function openNotasModal(hijo) {
	notasHijoId = hijo.id;

	document.getElementById("notasModalNombre").textContent = hijo.nombre;
	document.getElementById("notasModal").classList.remove("hidden");

	// Traer libretas del hijo
	const res = await fetch(`/admin/users/${hijo.id}/grades`, {
		headers: { "Authorization": "Bearer " + token }
	});
	if(!res.ok) return alert("Error al cargar las libretas");
	const data = await res.json();
	// Orden ascendente por categor√≠a (num√©rico)
	notasHijo = data.notas.sort((a,b) => parseInt(a.categoria,10) - parseInt(b.categoria,10));

	// Buscar √≠ndice de la categor√≠a que coincida con el nivel del hijo
	const nivelHijo = hijo.rol_nivel ?? 1; // fallback a 1
	let indexPorNivel = notasHijo.findIndex(n => parseInt(n.categoria,10) === nivelHijo-1);

	if(indexPorNivel >= 0) {
		// Si ya existe esa libreta, abrir en ella
		categoriaIndex = indexPorNivel;
	} else {
		// Solo crear una nueva si el nivel es mayor a la √∫ltima categor√≠a existente
		const ultimaCategoria = parseInt(notasHijo[notasHijo.length - 1]?.categoria ?? 0, 10);
		if(nivelHijo > ultimaCategoria) {
			notasHijo.push({ categoria: nivelHijo });
			categoriaIndex = notasHijo.length - 1;
		} else {
			// Si el nivel es menor que la √∫ltima, pero no existe, lo ubicamos en la m√°s cercana
			categoriaIndex = 0; 
		}
	}
	renderLibretaModal();
}

function renderLibretaModal() {
	if(notasHijo.length === 0) {
		// si no tiene ninguna, crear temporalmente la categor√≠a 1
		notasHijo = [{ categoria: 1 }];
	}

	const n = notasHijo[categoriaIndex];
	const rolPorCategoria = {
		1: "IX GUP - CINTURON BLANCO PUNTA AMARILLA",
		2: "VIII GUP - CINTURON AMARILLO",
		3: "VII GUP - CINTURON AMARILLO PUNTA VERDE",
		4: "VI GUP - CINTURON VERDE",
		5: "V GUP - CINTURON VERDE PUNTA AZUL",
		6: "IV GUP - CINTURON AZUL",
		7: "III GUP - CINTURON AZUL PUNTA ROJA",
		8: "II GUP - CINTURON ROJO",
		9: "I GUP - CINTURON ROJO PUNTA NEGRA",
		10: "I DAN",
		11: "II DAN",
		12: "III DAN",
		13: "IV DAN",
		14: "V DAN",
		15: "VI DAN",
		16: "VII DAN",
		17: "VIII DAN",
		18: "IX DAN"
	};

	document.getElementById("categoriaLabel").textContent = `Categor√≠a: ${rolPorCategoria[n.categoria] || n.categoria}`;

	const materias = {
		desarrollo_tecnico: "DESARROLLO",
		tul: "TUL",
		lucha: "1/2 LUCHA",
		combate: "COMBATE",
		rotura: "ROTURA",
		zafes: "ZAFES/PALANCAS/LANCES/CAIDAS",
		enfrentamientos: "ENFRENTAMIENTOS",
		movimientos: "MOVIMIENTOS FUNDAMENTALES",
		teoria: "TEOR√çA",
		actitud_marcial: "ACTITUD MARCIAL"
	};

	let html = `<div class="overflow-x-auto">
		<table class="min-w-full border-collapse text-left">
			<thead>
				<tr>
					<th class="border px-2 py-1"></th>
					<th class="bg-gray-400 border px-2 py-1 text-center">NAOP</th>
					<th class="bg-gray-400 border px-2 py-1 text-center">AOP</th>
					<th class="bg-gray-400 border px-2 py-1 text-center">SOP</th>
				</tr>
			</thead>
			<tbody>`;

	Object.keys(materias).forEach(col => {
		const valor = n[col] ?? -1;
		html += `<tr class="hover:bg-gray-300">
			<td class="border px-4 py-2 font-semibold">${materias[col]}</td>
			<td class="border px-4 py-2 text-center"><input type="radio" name="${col}" value="0" ${valor===0?"checked":""}></td>
			<td class="border px-4 py-2 text-center"><input type="radio" name="${col}" value="1" ${valor===1?"checked":""}></td>
			<td class="border px-4 py-2 text-center"><input type="radio" name="${col}" value="2" ${valor===2?"checked":""}></td>
		</tr>`;
	});

	html += `</tbody></table></div>`;
	document.getElementById("libretaModalContainer").innerHTML = html;
}

// Cerrar modal
document.getElementById("cerrarNotasBtn").addEventListener("click", () => {
	document.getElementById("notasModal").classList.add("hidden");
});

// Cambiar categor√≠a
document.getElementById("prevCategoria").addEventListener("click", () => {
	if(categoriaIndex > 0) {
		categoriaIndex--;
		renderLibretaModal();
	}
});

document.getElementById("nextCategoria").addEventListener("click", () => {
	if (categoriaIndex < notasHijo.length - 1) {
		// Si ya existe la siguiente, solo moverse
		categoriaIndex++;
	} else {
		// Si estamos en la √∫ltima, crear una nueva categor√≠a consecutiva
		const ultimaCategoria = parseInt(notasHijo[notasHijo.length - 1].categoria, 10);

		if (ultimaCategoria < 18) { // <-- TOPE M√ÅXIMO
			const nuevaCategoria = ultimaCategoria + 1;
			notasHijo.push({ categoria: nuevaCategoria });
			categoriaIndex = notasHijo.length - 1;
		}
	}
	renderLibretaModal();
});


// Guardar notas
document.getElementById("guardarNotasBtn").addEventListener("click", async () => {
	const inputs = document.querySelectorAll("#libretaModalContainer input[type=radio]");
	const payload = { categoria: notasHijo[categoriaIndex].categoria };

	inputs.forEach(i => {
		if(i.checked) payload[i.name] = parseInt(i.value);
	});

	const res = await fetch(`/admin/users/${notasHijoId}/grades`, {
		method: "PATCH",
		headers: {
			"Authorization": "Bearer " + token,
			"Content-Type": "application/json"
		},
		body: JSON.stringify(payload)
	});

	if(res.ok) alert("Notas guardadas correctamente");
	else alert(await res.text());
});

// ============================
// SEDES Y MAPA
// ============================
const sedesList = document.getElementById("sedesList");
const sedeForm = document.getElementById("sedeForm");
const sedeIdInput = document.getElementById("sedeId");
const sedeNombreInput = document.getElementById("sedeNombre");
const sedeDescripcionInput = document.getElementById("sedeDescripcion");
const sedeCoordsInput = document.getElementById("sedeCoords");
const sedeCiudadInput = document.getElementById("sedeCiudad");
const cancelSedeBtn = document.getElementById("cancelSedeBtn");

// Cargar sedes desde la base de datos
async function loadSedes() {
    sedesList.innerHTML = "Cargando...";
    const res = await fetch("/admin/sedes", {
        headers: { "Authorization": "Bearer " + token }
    });
    if(!res.ok) return alert("Error al cargar sedes");
    const sedes = await res.json();
    sedesList.innerHTML = "";

    sedes.forEach(s => {
        const div = document.createElement("div");
        div.className = "p-4 border rounded-xl shadow-md bg-white dark:bg-gray-200 flex flex-col gap-2";

		div.innerHTML = `
			<span class="font-semibold">${s.nombre}</span>
			<span class="whitespace-pre-wrap">${s.descripcion || ""}</span>
			<span>Ciudad: ${s.ciudad || "-"}</span>
			<span>Lat: ${s.lat}, Lng: ${s.lng}</span>
			<div class="flex gap-2">
				<button class="editSedeBtn flex-1 px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Editar</button>
				<button class="delSedeBtn flex-1 px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Eliminar</button>
			</div>
		`;

        div.querySelector(".editSedeBtn").onclick = () => {
            sedeIdInput.value = s.id;
            sedeNombreInput.value = s.nombre;
			sedeDescripcionInput.value = s.descripcion || "";
			sedeCoordsInput.value = `${s.lat}, ${s.lng}`;
			sedeCiudadInput.value = s.ciudad || "";
        };

        div.querySelector(".delSedeBtn").onclick = async () => {
            if(!confirm(`Eliminar sede "${s.nombre}"?`)) return;
            const res = await fetch(`/admin/sedes/${s.id}`, {
                method: "DELETE",
                headers: { "Authorization": "Bearer " + token }
            });
            if(res.ok) loadSedes();
            else alert(await res.text());
        };

        sedesList.appendChild(div);
    });
}

// Guardar nueva sede o editar existente
sedeForm.addEventListener("submit", async e => {
    e.preventDefault();
    const id = sedeIdInput.value;
    // Tomar coordenadas y separarlas
    const [latStr, lngStr] = sedeCoordsInput.value.split(",").map(v => v.trim());
    const latValue = parseFloat(latStr);
    const lngValue = parseFloat(lngStr);

    if (isNaN(latValue) || isNaN(lngValue)) {
        return alert("Coordenadas inv√°lidas. Usa el formato: lat, lng");
    }
    const payload = {
        nombre: sedeNombreInput.value.trim(),
		descripcion: sedeDescripcionInput.value.trim(),
		lat: latValue,
		lng: lngValue,
		ciudad: sedeCiudadInput.value.trim()
    };

    let res;
    if(id) {
        // Editar
        res = await fetch(`/admin/sedes/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
            body: JSON.stringify(payload)
        });
    } else {
        // Crear
        res = await fetch("/admin/sedes", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
            body: JSON.stringify(payload)
        });
    }

    if(res.ok){
        sedeForm.reset();
        sedeIdInput.value = "";
		sedeDescripcionInput.value = "";
        loadSedes();
    } else {
        alert(await res.text());
    }
});

// Cancelar edici√≥n
cancelSedeBtn.onclick = () => {
    sedeForm.reset();
    sedeIdInput.value = "";
	sedeDescripcionInput.value = "";
};

// ============================
// ALBUMES
// ============================
const albumesList = document.getElementById("albumesList");
const albumForm = document.getElementById("albumForm");
const albumIdInput = document.getElementById("albumId");
const albumNombreInput = document.getElementById("albumNombre");
const albumDescripcionInput = document.getElementById("albumDescripcion");
const albumFotosInput = document.getElementById("albumFotos");
const cancelAlbumBtn = document.getElementById("cancelAlbumBtn");

// Parsear links estilo [url=...][img]...[/img][/url]
function parseFotoLinks(text) {
  return text.split("\n").map(l => {
    const match = l.match(/\[img\](.*?)\[\/img\]/);
    return match ? match[1] : null;
  }).filter(Boolean);
}

// Cargar √°lbumes
async function loadAlbumes() {
  albumesList.innerHTML = "Cargando...";
  const res = await fetch("/albumes", {
    headers: { "Authorization": "Bearer " + token }
  });
  if(!res.ok) return alert("Error al cargar √°lbumes");
  const albums = await res.json();
  albumesList.innerHTML = "";

  albums.forEach(a => {
    const div = document.createElement("div");
    div.className = "p-4 border rounded shadow bg-white flex flex-col gap-2";
    div.innerHTML = `
      <span class="font-semibold">${a.nombre}</span>
      <p>${a.descripcion || ""}</p>
      <div class="flex gap-2 overflow-x-auto">
        ${a.fotos.map(f => `<img src="${f}" class="h-20 rounded">`).join("")}
      </div>
      <div class="flex gap-2">
        <button class="editAlbumBtn flex-1 bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">Editar</button>
        <button class="delAlbumBtn flex-1 bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">Eliminar</button>
      </div>
    `;

    div.querySelector(".editAlbumBtn").onclick = () => {
      albumIdInput.value = a.id;
      albumNombreInput.value = a.nombre;
      albumDescripcionInput.value = a.descripcion || "";
      albumFotosInput.value = a.fotos.map(f => `[url=${f}][img]${f}[/img][/url]`).join("\n");
    };

    div.querySelector(".delAlbumBtn").onclick = async () => {
      if(!confirm(`Eliminar √°lbum "${a.nombre}"?`)) return;
      const res = await fetch(`/albumes/${a.id}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
      });
      if(res.ok) loadAlbumes();
      else alert(await res.text());
    };

    albumesList.appendChild(div);
  });
}

// Guardar √°lbum
albumForm.addEventListener("submit", async e => {
  e.preventDefault();
  const id = albumIdInput.value;
  const fotos = parseFotoLinks(albumFotosInput.value);
  const payload = {
    nombre: albumNombreInput.value.trim(),
    descripcion: albumDescripcionInput.value.trim(),
    fotos
  };

  let res;
  if(id) {
    res = await fetch(`/albumes/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
      body: JSON.stringify(payload)
    });
  } else {
    res = await fetch("/albumes", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
      body: JSON.stringify(payload)
    });
  }

  if(res.ok) {
    albumForm.reset();
    albumIdInput.value = "";
    loadAlbumes();
  } else {
    alert(await res.text());
  }
});

// Cancelar
cancelAlbumBtn.onclick = () => {
  albumForm.reset();
  albumIdInput.value = "";
};

</script>
</body>
</html>